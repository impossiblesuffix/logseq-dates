<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logseq Weekly Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #1a1a1a;
        min-height: 100vh;
        padding: 20px;
        color: #e8e8e8;
    }
    
    .container {
        max-width: 800px;
        margin: 0 auto;
        background: #2a2a2a;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.4);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%);
        padding: 30px;
        color: white;
        text-align: center;
    }
    
    h1 {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -0.5px;
    }
    
    .content {
        padding: 30px;
    }
    
    .section {
        margin-bottom: 35px;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #e8e8e8;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .section-title::before {
        content: '';
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%);
        border-radius: 2px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #b8b8b8;
        font-size: 14px;
    }
    
    input[type="date"],
    input[type="number"],
    input[type="text"],
    select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #3a3a3a;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.2s ease;
        background: #333;
        color: #e8e8e8;
    }
    
    input[type="date"]:focus,
    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
        outline: none;
        border-color: #b0513f;
        background: #3a3a3a;
    }
    
    input::placeholder,
    textarea::placeholder {
        color: #6b6b6b;
    }
    
    select option {
        background: #2a2a2a;
        color: #e8e8e8;
    }
    
    input[type="checkbox"] {
        accent-color: #b0513f;
    }
    
    .date-select-btn {
        font-weight: 500;
        white-space: nowrap;
    }
    
    .date-select-btn:hover {
        transform: translateY(-1px);
    }
    
    .work-type-btn {
        transition: all 0.15s ease;
    }
    
    .work-type-btn:hover {
        transform: translateY(-1px);
    }
    
    #outputPreview {
        scrollbar-width: thin;
        scrollbar-color: #b0513f #2a2a2a;
    }
    
    #outputPreview::-webkit-scrollbar {
        width: 8px;
    }
    
    #outputPreview::-webkit-scrollbar-track {
        background: #2a2a2a;
        border-radius: 4px;
    }
    
    #outputPreview::-webkit-scrollbar-thumb {
        background: #b0513f;
        border-radius: 4px;
    }
    
    #outputPreview::-webkit-scrollbar-thumb:hover {
        background: #8d3d2f;
    }
    
    .quick-options {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    
    button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: 'Quicksand', sans-serif;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background: #2a2a2a;
        color: #b0513f;
        border: 2px solid #b0513f;
    }
    
    .btn-secondary:hover {
        background: #3a3a3a;
    }
    
    .btn-small {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    textarea {
        width: 100%;
        padding: 16px;
        border: 2px solid #3a3a3a;
        border-radius: 8px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 14px;
        resize: vertical;
        background: #333;
        color: #e8e8e8;
        min-height: 300px;
        line-height: 1.5;
    }
    
    textarea:focus {
        outline: none;
        border-color: #b0513f;
        background: #3a3a3a;
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        padding: 8px;
        border-radius: 6px;
        transition: background 0.2s ease;
    }
    
    .checkbox-group:hover {
        background: #333;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-weight: 400;
    }
    
    .success-message {
        background: #065f46;
        color: #d1fae5;
        padding: 14px 16px;
        border-radius: 8px;
        margin-top: 12px;
        display: none;
        font-size: 15px;
        text-align: center;
        font-weight: 500;
    }
    
    .habit-item {
        background: #333;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
        border: 2px solid #3a3a3a;
        transition: all 0.2s ease;
    }
    
    .habit-item:hover {
        border-color: #b0513f;
    }
    
    .habit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .habit-name {
        font-weight: 500;
        color: #e8e8e8;
    }
    
    .btn-remove {
        background: #ff6b6b;
        color: white;
        padding: 8px 16px;
        font-size: 13px;
        white-space: nowrap;
    }
    
    .btn-remove:hover {
        background: #ee5a5a;
    }
    
    .habit-config {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    .preset-habits {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    
    .btn-preset {
        padding: 8px 14px;
        font-size: 13px;
        background: #2a2a2a;
        color: #b0513f;
        border: 1.5px solid #b0513f;
    }
    
    .btn-preset:hover {
        background: #b0513f;
        color: white;
    }
    
    .freq-btn {
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
        font-weight: 500;
    }
    
    .freq-btn:hover {
        transform: translateY(-1px);
    }
    
    .date-range-info {
        background: #333;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #b0513f;
    }
    
    .date-range-info strong {
        color: #b0513f;
    }
    
    .date-picker-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-top: 10px;
    }
    
    .date-picker-header {
        text-align: center;
        font-weight: 600;
        color: #888;
        font-size: 12px;
        padding: 8px 4px;
    }
    
    .date-picker-btn {
        padding: 8px 4px;
        font-size: 12px;
        text-align: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
        background: #2a2a2a;
        color: #888;
        border: 1px solid #3a3a3a;
    }
    
    .date-picker-btn:hover {
        background: #3a3a3a;
        color: #e8e8e8;
    }
    
    .date-picker-btn.available {
        background: #333;
        color: #e8e8e8;
        border-color: #444;
    }
    
    .date-picker-btn.selected {
        background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%);
        color: white;
        border-color: #b0513f;
    }
    
    .date-picker-btn.in-range {
        background: rgba(176, 81, 63, 0.3);
        color: #e8e8e8;
        border-color: rgba(176, 81, 63, 0.5);
    }
    
    .date-picker-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    .month-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .month-nav button {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .month-nav span {
        font-weight: 600;
        font-size: 16px;
    }
    
    @media (max-width: 600px) {
        body {
            padding: 10px;
        }
        
        .row, .habit-config {
            grid-template-columns: 1fr;
            gap: 18px;
        }
        
        h1 {
            font-size: 24px;
        }
        
        .content {
            padding: 20px;
        }
        
        .header {
            padding: 20px;
        }
        
        button {
            padding: 14px 20px;
            font-size: 16px;
        }
        
        .btn-primary,
        .btn-secondary {
            width: 100%;
        }
        
        .btn-remove {
            width: auto !important;
            padding: 10px 16px !important;
            font-size: 14px !important;
        }
        
        .btn-small {
            padding: 12px 16px;
            font-size: 15px;
        }
        
        .quick-options button {
            flex: 1 1 calc(50% - 4px);
            min-width: 0;
            width: auto;
            font-size: 14px;
            padding: 10px 8px;
        }
        
        .preset-habits .btn-preset {
            flex: 1 1 calc(50% - 4px);
            padding: 10px 12px;
            width: auto;
        }
        
        input[type="date"],
        input[type="number"],
        input[type="text"],
        select {
            padding: 13px 10px;
            font-size: 16px;
            max-width: 100%;
        }
        
        input[type="date"] {
            padding: 10px 8px;
            font-size: 15px;
            letter-spacing: -0.4px;
        }
        
        input[type="text"] {
            text-align: left;
        }
        
        textarea {
            font-size: 14px;
            padding: 14px;
            min-height: 250px;
        }
        
        .checkbox-group {
            padding: 12px 8px;
            margin-bottom: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            min-width: 20px;
        }
        
        .checkbox-group label {
            font-size: 15px;
            line-height: 1.4;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            font-size: 14px;
            margin-bottom: 6px;
        }
        
        .habit-item {
            padding: 14px;
        }
        
        .custom-habit-input {
            flex-direction: column !important;
        }
        
        .custom-habit-input input {
            width: 100%;
        }
        
        .custom-habit-input button {
            width: 100%;
        }
        
        .freq-btn {
            flex: 1 1 calc(25% - 6px) !important;
            min-width: 45px !important;
            padding: 12px 8px !important;
            font-size: 16px !important;
        }
        
        .date-select-btn {
            padding: 10px 12px !important;
            font-size: 14px !important;
            min-width: 60px;
        }
        
        .work-type-btn {
            padding: 12px 14px !important;
            font-size: 15px !important;
            flex: 1 1 calc(50% - 6px) !important;
            min-width: 0 !important;
        }
        
        #outputPreview {
            font-size: 14px !important;
            padding: 15px !important;
        }
        
        .date-picker-grid {
            gap: 2px;
        }
        
        .date-picker-btn {
            padding: 10px 2px;
            font-size: 11px;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>✨ Logseq Weekly Planner</h1>
        </div>

```
    <!-- Tab Navigation -->
    <div style="display: flex; border-bottom: 2px solid #3a3a3a; background: #2a2a2a;">
        <button id="tabCreate" onclick="switchTab('create')" style="flex: 1; padding: 16px; background: #333; color: #e8e8e8; border: none; border-bottom: 3px solid #b0513f; font-weight: 600; cursor: pointer; font-family: 'Quicksand', sans-serif; font-size: 14px;">
            Create New Plan
        </button>
        <button id="tabImport" onclick="switchTab('import')" style="flex: 1; padding: 16px; background: #2a2a2a; color: #888; border: none; border-bottom: 3px solid transparent; font-weight: 600; cursor: pointer; font-family: 'Quicksand', sans-serif; font-size: 14px;">
            Import & Add Items
        </button>
    </div>
    
    <!-- Create New Plan View -->
    <div id="createView" class="content">
        <!-- Date Range Section -->
        <div class="section">
            <div class="section-title">Date Range</div>
            
            <div class="form-group">
                <label for="planTitle">Plan Title (optional)</label>
                <input type="text" id="planTitle" placeholder="e.g., February Planning, Q1 Goals">
            </div>
            
            <div class="form-group">
                <div class="quick-options">
                    <button class="btn-secondary btn-small" onclick="setQuickRange(7)">Next 7 Days</button>
                    <button class="btn-secondary btn-small" onclick="setQuickRange(14)">Next 14 Days</button>
                    <button class="btn-secondary btn-small" onclick="setQuickRange(30)">Next 30 Days</button>
                    <button class="btn-secondary btn-small" onclick="setMonthRange()">This Month</button>
                    <button class="btn-secondary btn-small" onclick="setMonthRange(1)">Next Month</button>
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
            </div>
        </div>
        
        <!-- Format Options -->
        <div class="section">
            <div class="section-title">Format Options</div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="groupByWeeks" checked>
                <label for="groupByWeeks">Group days by weeks</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="useHeadings" checked>
                <label for="useHeadings">Use heading format for dates (###)</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="includeDayName" checked>
                <label for="includeDayName">Show day name before date</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="longDayName">
                <label for="longDayName">Use full day names (Monday vs Mon)</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="dashSeparator" checked>
                <label for="dashSeparator">Add dash between day name and date</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="addTodo">
                <label for="addTodo">Make items TODO tasks</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="addSubBullet">
                <label for="addSubBullet">Add empty sub-bullet under each date</label>
            </div>
            
            <div class="form-group">
                <label for="dateFormat">Date Format</label>
                <select id="dateFormat">
                    <option value="MMM Do, yyyy">Jan 23rd, 2026</option>
                    <option value="MMM Do">Jan 23rd</option>
                    <option value="D MMM">23 Jan</option>
                    <option value="DD MMM">23 Jan</option>
                    <option value="D MMM yyyy">23 Jan 2026</option>
                    <option value="D MMMM">23 January</option>
                    <option value="DD MMMM">23 January</option>
                </select>
            </div>
        </div>
        
        <!-- Habits & Events Section -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="section-title" style="margin-bottom: 0;">Habits & Events</div>
                <div style="display: flex; gap: 6px;">
                    <button class="btn-secondary" onclick="saveDefaultHabits()" style="padding: 6px 12px; font-size: 13px;">Export Habits</button>
                    <button class="btn-secondary" onclick="loadDefaultHabits()" style="padding: 6px 12px; font-size: 13px;">Import Habits</button>
                    <input type="file" id="habitFileInput" accept=".json" onchange="handleHabitFileUpload(event)" style="display: none;">
                </div>
            </div>
            
            <div class="form-group">
                <label>Quick Add Common Items</label>
                <div class="preset-habits">
                    <button class="btn-preset" onclick="addPresetHabit('Work', true)">Work</button>
                    <button class="btn-preset" onclick="addPresetHabit('Exercise')">Exercise</button>
                    <button class="btn-preset" onclick="addPresetHabit('Meditation')">Meditation</button>
                    <button class="btn-preset" onclick="addPresetHabit('Medication')">Medication</button>
                    <button class="btn-preset" onclick="addPresetHabit('Supplements')">Supplements</button>
                    <button class="btn-preset" onclick="addPresetHabit('Weekly Review')">Weekly Review</button>
                    <button class="btn-preset" onclick="addPresetHabit('Physio')">Physio</button>
                    <button class="btn-preset" onclick="addPresetHabit('Cleaning')">Cleaning</button>
                    <button class="btn-preset" onclick="addPresetHabit('Laundry')">Laundry</button>
                    <button class="btn-preset" onclick="addPresetHabit('Garbage')">Garbage</button>
                    <button class="btn-preset" onclick="addPresetHabit('Dinner?')">Dinner?</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="customHabit">Or Add Custom Item</label>
                <div style="display: flex; gap: 8px;" class="custom-habit-input">
                    <input type="text" id="customHabit" placeholder="E.g., Call mom, Pay rent, Track expenses..." onkeypress="if(event.key === 'Enter') addCustomHabit()">
                    <button class="btn-secondary" onclick="addCustomHabit()">Add</button>
                </div>
            </div>
            
            <div id="habitsList" style="margin-top: 20px;"></div>
        </div>
        
        <!-- Generate Button -->
        <button class="btn-primary" onclick="generateOutput()" style="width: 100%; margin-bottom: 20px;">
            Generate Plan
        </button>
        
        <!-- Output Section -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="section-title" style="margin-bottom: 0;">Output</div>
                <label style="display: flex; align-items: center; gap: 6px; margin: 0; font-size: 14px; color: #b8b8b8; cursor: pointer;">
                    <input type="checkbox" id="showPreview" onchange="togglePreview()" checked>
                    Preview
                </label>
            </div>
            
            <textarea id="output" readonly onclick="this.select()" ontouchstart="this.select()" style="display: none;"></textarea>
            
            <div id="outputPreview" style="display: block; padding: 20px; background: #1a1a1a; border: 2px solid #3a3a3a; border-radius: 8px; font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 15px; line-height: 1.8; color: #e8e8e8; max-height: 600px; overflow-y: auto;">
                <p style="color: #888; font-style: italic;">Generate a plan to see preview</p>
            </div>
            
            <button class="btn-primary" onclick="copyToClipboard()" style="margin-top: 12px;">
                Copy to Clipboard
            </button>
            <div class="success-message" id="successMessage">✓ Copied to clipboard!</div>
        </div>
    </div>
    
    <!-- Import & Add Items View -->
    <div id="importView" class="content" style="display: none;">
        <!-- Import Section -->
        <div class="section">
            <div class="section-title">Import Existing Plan</div>
            
            <div class="form-group">
                <label for="importText">Paste Your Logseq Plan (Markdown)</label>
                <textarea id="importText" 
                          placeholder="Paste your existing Logseq plan here..." 
                          style="min-height: 200px; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px;"
                          spellcheck="false"
                          oninput="updateCharCount()"
                          autocomplete="off"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <p style="color: #888; font-size: 13px; margin: 0;">
                        <span id="charCount">0</span> characters
                    </p>
                    <button type="button" onclick="document.getElementById('importText').value=''; updateCharCount();" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Or Upload a Markdown File</label>
                <input type="file" id="importFile" accept=".txt,.md" onchange="loadFileContent()" style="padding: 8px;">
            </div>
            
            <button class="btn-primary" onclick="parseImportedPlan()" style="width: 100%;">
                Parse Plan
            </button>
        </div>
        
        <!-- Date Range Selection Section -->
        <div id="dateRangeSection" class="section" style="display: none;">
            <div class="section-title">Select Date Range</div>
            
            <div class="date-range-info" id="dateRangeInfo">
            </div>
            
            <div class="form-group">
                <label>Click to select start date, then end date:</label>
                <div class="month-nav">
                    <button class="btn-secondary btn-small" onclick="navigateMonth(-1)">← Prev</button>
                    <span id="currentMonthLabel">January 2026</span>
                    <button class="btn-secondary btn-small" onclick="navigateMonth(1)">Next →</button>
                </div>
                <div id="datePickerGrid" class="date-picker-grid">
                </div>
            </div>
            
            <div class="row" style="margin-top: 15px;">
                <div class="form-group">
                    <label>Selected Start</label>
                    <input type="text" id="importStartDate" readonly placeholder="Click a date above">
                </div>
                <div class="form-group">
                    <label>Selected End</label>
                    <input type="text" id="importEndDate" readonly placeholder="Click a date above">
                </div>
            </div>
            
            <button class="btn-primary" onclick="confirmDateRange()" style="width: 100%; margin-top: 10px;">
                Continue with Selected Range
            </button>
        </div>
        
        <!-- Add Items Section -->
        <div id="addItemsSection" class="section" style="display: none;">
            <div class="section-title">Add Items to Selected Range</div>
            
            <div class="date-range-info" id="selectedRangeInfo">
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <label style="margin: 0;">Quick Add Common Items</label>
                <div style="display: flex; gap: 6px;">
                    <button class="btn-secondary" onclick="saveDefaultHabits()" style="padding: 6px 12px; font-size: 13px;">Export</button>
                    <button class="btn-secondary" onclick="loadDefaultHabitsImport()" style="padding: 6px 12px; font-size: 13px;">Import</button>
                    <input type="file" id="habitFileInputImport" accept=".json" onchange="handleHabitFileUploadImport(event)" style="display: none;">
                </div>
            </div>
            
            <div class="form-group">
                <div class="preset-habits">
                    <button class="btn-preset" onclick="addImportHabit('Work', true)">Work</button>
                    <button class="btn-preset" onclick="addImportHabit('Exercise')">Exercise</button>
                    <button class="btn-preset" onclick="addImportHabit('Meditation')">Meditation</button>
                    <button class="btn-preset" onclick="addImportHabit('Medication')">Medication</button>
                    <button class="btn-preset" onclick="addImportHabit('Supplements')">Supplements</button>
                    <button class="btn-preset" onclick="addImportHabit('Weekly Review')">Weekly Review</button>
                    <button class="btn-preset" onclick="addImportHabit('Physio')">Physio</button>
                    <button class="btn-preset" onclick="addImportHabit('Cleaning')">Cleaning</button>
                    <button class="btn-preset" onclick="addImportHabit('Laundry')">Laundry</button>
                    <button class="btn-preset" onclick="addImportHabit('Garbage')">Garbage</button>
                    <button class="btn-preset" onclick="addImportHabit('Dinner?')">Dinner?</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="importCustomHabit">Or Add Custom Item</label>
                <div style="display: flex; gap: 8px;" class="custom-habit-input">
                    <input type="text" id="importCustomHabit" placeholder="E.g., Call mom, Pay rent..." onkeypress="if(event.key === 'Enter') addCustomImportHabit()">
                    <button class="btn-secondary" onclick="addCustomImportHabit()">Add</button>
                </div>
            </div>
            
            <div id="importHabitsList" style="margin-top: 20px;"></div>
            
            <button class="btn-primary" onclick="generateMergedOutput()" style="width: 100%; margin-top: 20px;">
                Generate Merged Plan
            </button>
        </div>
        
        <!-- Merged Output Section -->
        <div id="mergedOutputSection" class="section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="section-title" style="margin-bottom: 0;">Merged Output</div>
                <label style="display: flex; align-items: center; gap: 6px; margin: 0; font-size: 14px; color: #b8b8b8; cursor: pointer;">
                    <input type="checkbox" id="showMergedPreview" onchange="toggleMergedPreview()" checked>
                    Preview
                </label>
            </div>
            
            <textarea id="mergedOutput" readonly onclick="this.select()" ontouchstart="this.select()" style="display: none;"></textarea>
            
            <div id="mergedOutputPreview" style="display: block; padding: 20px; background: #1a1a1a; border: 2px solid #3a3a3a; border-radius: 8px; font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 15px; line-height: 1.8; color: #e8e8e8; max-height: 600px; overflow-y: auto;">
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                <button class="btn-primary" onclick="copyMergedToClipboard()">
                    Copy to Clipboard
                </button>
                <button class="btn-secondary" onclick="downloadMergedOutput()">
                    Download
                </button>
                <button class="btn-secondary" onclick="saveToOriginalFile()">
                    Save to File
                </button>
            </div>
            <div class="success-message" id="mergedSuccessMessage">✓ Copied to clipboard!</div>
            <div class="success-message" id="savedSuccessMessage">✓ Saved to file!</div>
        </div>
    </div>
</div>

<script>
    let habits = [];
    let importHabits = [];
    
    // Import state
    let importState = {
        originalText: '',
        originalLines: [],
        availableDates: [],  // Array of Date objects
        availableDateStrings: [],  // Original strings as they appear in the file
        dateToLineIndex: {},  // Maps date key to line index
        selectedStart: null,
        selectedEnd: null,
        currentViewMonth: null,
        fileName: null  // Store uploaded filename for saving
    };
    
    // Set default dates
    function setDefaultDates() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 7);
        
        document.getElementById('startDate').valueAsDate = tomorrow;
        document.getElementById('endDate').valueAsDate = endDate;
    }
    
    function setQuickRange(days) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + days);
        
        document.getElementById('startDate').valueAsDate = tomorrow;
        document.getElementById('endDate').valueAsDate = endDate;
    }
    
    function setMonthRange(monthOffset = 0) {
        const now = new Date();
        const targetMonth = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
        
        const startDate = new Date(targetMonth.getFullYear(), targetMonth.getMonth(), 1);
        const endDate = new Date(targetMonth.getFullYear(), targetMonth.getMonth() + 1, 0);
        
        document.getElementById('startDate').valueAsDate = startDate;
        document.getElementById('endDate').valueAsDate = endDate;
        document.getElementById('groupByWeeks').checked = true;
    }
    
    function addPresetHabit(name, isWorkSchedule = false) {
        addHabit(name, isWorkSchedule);
    }
    
    function addCustomHabit() {
        const input = document.getElementById('customHabit');
        const name = input.value.trim();
        if (name) {
            addHabit(name);
            input.value = '';
        }
    }
    
    function addHabit(name, isWorkSchedule = false) {
        const habit = {
            id: Date.now(),
            name: name,
            type: isWorkSchedule ? 'selected-dates' : 'unscheduled',
            frequency: 1,
            specificDate: '',
            weekday: 'Monday',
            monthDay: 1,
            selectedDates: [],
            isWorkSchedule: isWorkSchedule,
            workDates: {},
            currentWorkType: 'A WFH',
            repeatPattern: 'every-n-days',
            repeatInterval: 2,
            repeatStartDate: ''
        };
        habits.unshift(habit);
        renderHabits();
    }
    
    function removeHabit(id) {
        habits = habits.filter(h => h.id !== id);
        renderHabits();
    }
    
    function updateHabit(id, field, value) {
        const habit = habits.find(h => h.id === id);
        if (habit) {
            habit[field] = value;
            if (field === 'type') {
                renderHabits();
            }
        }
    }
    
    function saveDefaultHabits() {
        const habitsToSave = habits.length > 0 ? habits : importHabits;
        if (habitsToSave.length === 0) {
            alert('No habits to save. Add some habits first.');
            return;
        }
        
        try {
            const dataStr = JSON.stringify(habitsToSave, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'logseq-planner-habits.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert(`✓ Saved ${habitsToSave.length} habit(s) to file`);
        } catch (error) {
            console.error('Error saving defaults:', error);
            alert('Error saving defaults: ' + error.message);
        }
    }
    
    function loadDefaultHabits() {
        document.getElementById('habitFileInput').click();
    }
    
    function handleHabitFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedHabits = JSON.parse(e.target.result);
                
                if (!Array.isArray(loadedHabits) || loadedHabits.length === 0) {
                    alert('Invalid habits file or file is empty.');
                    return;
                }
                
                if (habits.length > 0) {
                    if (!confirm(`This will replace your current ${habits.length} habit(s) with ${loadedHabits.length} saved habit(s). Continue?`)) {
                        return;
                    }
                }
                
                habits = loadedHabits.map(h => ({
                    ...h,
                    id: Date.now() + Math.random()
                }));
                
                renderHabits();
                alert(`✓ Loaded ${habits.length} habit(s) from file`);
            } catch (error) {
                console.error('Error loading habits:', error);
                alert('Error loading file. Make sure it\'s a valid habits file.');
            }
        };
        
        reader.readAsText(file);
        event.target.value = '';
    }
    
    function toggleDate(habitId, dateKey) {
        const habit = habits.find(h => h.id === habitId);
        if (habit) {
            if (habit.isWorkSchedule) {
                if (!habit.workDates) habit.workDates = {};
                if (habit.workDates[dateKey] === habit.currentWorkType) {
                    delete habit.workDates[dateKey];
                } else {
                    habit.workDates[dateKey] = habit.currentWorkType;
                }
            } else {
                if (!habit.selectedDates) habit.selectedDates = [];
                const index = habit.selectedDates.indexOf(dateKey);
                if (index > -1) {
                    habit.selectedDates.splice(index, 1);
                } else {
                    habit.selectedDates.push(dateKey);
                }
            }
            renderHabits();
        }
    }
    
    function setWorkType(habitId, workType) {
        const habit = habits.find(h => h.id === habitId);
        if (habit) {
            habit.currentWorkType = workType;
            renderHabits();
        }
    }
    
    function getWorkTypeColor(workType) {
        const colors = {
            'A WFH': { bg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', text: 'white' },
            'A Office': { bg: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', text: 'white' },
            'B WFH': { bg: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)', text: 'white' },
            'B Office': { bg: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', text: 'white' }
        };
        return colors[workType] || { bg: '#2a2a2a', text: '#b8b8b8' };
    }
    
    function getDateRangeButtons(habit) {
        const startInput = document.getElementById('startDate').value;
        const endInput = document.getElementById('endDate').value;
        
        if (!startInput || !endInput) {
            return '<span style="color: #888; font-size: 13px;">Set date range first</span>';
        }
        
        const startDate = new Date(startInput);
        const endDate = new Date(endInput);
        let output = '';
        
        if (habit.isWorkSchedule) {
            const workTypes = ['A WFH', 'A Office', 'B WFH', 'B Office'];
            output += '<div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">';
            workTypes.forEach(type => {
                const isActive = habit.currentWorkType === type;
                const colors = getWorkTypeColor(type);
                output += `
                    <button type="button"
                        onclick="setWorkType(${habit.id}, '${type}')"
                        class="work-type-btn"
                        style="padding: 10px 14px; font-size: 14px; border-radius: 6px; cursor: pointer; font-weight: 500; flex: 1; min-width: 80px; ${isActive ? `background: ${colors.bg}; color: ${colors.text}; border: none;` : 'background: #2a2a2a; color: #b8b8b8; border: 2px solid #3a3a3a;'}">
                        ${type}
                    </button>
                `;
            });
            output += '</div>';
            output += '<div style="border-top: 1px solid #3a3a3a; margin-bottom: 12px;"></div>';
        }
        
        const buttons = [];
        let currentDate = new Date(startDate);
        
        if (!habit.selectedDates) habit.selectedDates = [];
        if (!habit.workDates) habit.workDates = {};
        
        while (currentDate <= endDate) {
            const dateKey = currentDate.toISOString().split('T')[0];
            const dayName = currentDate.toLocaleDateString('en-GB', { weekday: 'short' });
            const day = currentDate.getDate();
            
            let isSelected, buttonStyle;
            
            if (habit.isWorkSchedule) {
                const workType = habit.workDates[dateKey];
                isSelected = !!workType;
                if (isSelected) {
                    const colors = getWorkTypeColor(workType);
                    buttonStyle = `background: ${colors.bg}; color: ${colors.text}; border: none;`;
                } else {
                    buttonStyle = 'background: #2a2a2a; color: #b8b8b8; border: 2px solid #3a3a3a;';
                }
            } else {
                isSelected = habit.selectedDates.includes(dateKey);
                buttonStyle = isSelected ? 
                    'background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%); color: white; border: none;' :
                    'background: #2a2a2a; color: #b8b8b8; border: 2px solid #3a3a3a;';
            }
            
            buttons.push(`
                <button type="button"
                    onclick="toggleDate(${habit.id}, '${dateKey}')"
                    style="padding: 8px 10px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: all 0.15s ease; ${buttonStyle}"
                    class="date-select-btn">
                    ${dayName} ${day}
                </button>
            `);
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        return output + buttons.join('');
    }
    
    function renderHabits() {
        const container = document.getElementById('habitsList');
        if (habits.length === 0) {
            container.innerHTML = '<p style="color: #888; font-style: italic;">No habits added yet. Add some above!</p>';
            return;
        }
        
        container.innerHTML = habits.map(habit => `
            <div class="habit-item">
                <div class="habit-header">
                    <div class="habit-name">${habit.name}</div>
                    <button class="btn-remove" onclick="removeHabit(${habit.id})">Remove</button>
                </div>
                <div class="habit-config">
                    <div class="form-group" style="margin: 0;">
                        <label>Schedule Type</label>
                        <select onchange="updateHabit(${habit.id}, 'type', this.value)" style="padding: 8px;">
                            <option value="unscheduled" ${habit.type === 'unscheduled' ? 'selected' : ''}>Unscheduled bullets</option>
                            <option value="daily" ${habit.type === 'daily' ? 'selected' : ''}>Daily (every day)</option>
                            <option value="weekly-day" ${habit.type === 'weekly-day' ? 'selected' : ''}>Every week on...</option>
                            <option value="monthly-day" ${habit.type === 'monthly-day' ? 'selected' : ''}>Every month on...</option>
                            <option value="repeating" ${habit.type === 'repeating' ? 'selected' : ''}>Repeating pattern</option>
                            <option value="selected-dates" ${habit.type === 'selected-dates' ? 'selected' : ''}>Selected dates</option>
                            <option value="specific-day" ${habit.type === 'specific-day' ? 'selected' : ''}>Specific date</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        ${getHabitConfigHTML(habit)}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    function getHabitConfigHTML(habit) {
        if (habit.type === 'unscheduled') {
            return `
                <label>Times per week</label>
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    ${[1,2,3,4,5,6,7].map(n => `
                        <button type="button" 
                            onclick="updateHabit(${habit.id}, 'frequency', ${n}); renderHabits();"
                            style="flex: 1 1 calc(25% - 6px); min-width: 40px; padding: 10px 8px; font-size: 15px; ${habit.frequency == n ? 'background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%); color: white;' : 'background: #2a2a2a; color: #b0513f; border: 2px solid #b0513f;'}"
                            class="freq-btn">
                            ${n}x
                        </button>
                    `).join('')}
                </div>
            `;
        } else if (habit.type === 'daily') {
            return `<label style="color: #888;">Will appear on every day</label>`;
        } else if (habit.type === 'repeating') {
            let html = `
                <label>Repeat Pattern</label>
                <select onchange="updateHabit(${habit.id}, 'repeatPattern', this.value); renderHabits();" style="padding: 8px; margin-bottom: 8px;">
                    <option value="every-n-days" ${habit.repeatPattern === 'every-n-days' ? 'selected' : ''}>Every N days</option>
                    <option value="weekdays" ${habit.repeatPattern === 'weekdays' ? 'selected' : ''}>Weekdays only (Mon-Fri)</option>
                    <option value="weekends" ${habit.repeatPattern === 'weekends' ? 'selected' : ''}>Weekends only (Sat-Sun)</option>
                </select>
            `;
            if (habit.repeatPattern === 'every-n-days') {
                html += `
                    <label>Every how many days?</label>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                        ${[2,3,4,5,6,7].map(n => `
                            <button type="button" 
                                onclick="updateHabit(${habit.id}, 'repeatInterval', ${n}); renderHabits();"
                                style="flex: 1 1 calc(33.33% - 6px); min-width: 50px; padding: 10px 8px; font-size: 15px; ${habit.repeatInterval == n ? 'background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%); color: white;' : 'background: #2a2a2a; color: #b0513f; border: 2px solid #b0513f;'}"
                                class="freq-btn">
                                ${n}
                            </button>
                        `).join('')}
                    </div>
                    <label>Start date (first occurrence)</label>
                    <input type="date" value="${habit.repeatStartDate || ''}"
                        onchange="updateHabit(${habit.id}, 'repeatStartDate', this.value)"
                        style="padding: 8px;">
                `;
            }
            return html;
        } else if (habit.type === 'selected-dates') {
            return `
                <label>Select dates (tap to toggle)</label>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; padding: 8px; background: #333; border-radius: 6px;">
                    ${getDateRangeButtons(habit)}
                </div>
            `;
        } else if (habit.type === 'specific-day') {
            return `
                <label>Date</label>
                <input type="date" value="${habit.specificDate}"
                    onchange="updateHabit(${habit.id}, 'specificDate', this.value)"
                    style="padding: 8px;">
            `;
        } else if (habit.type === 'weekly-day') {
            return `
                <label>Day of week</label>
                <select onchange="updateHabit(${habit.id}, 'weekday', this.value)" style="padding: 8px;">
                    <option ${habit.weekday === 'Sunday' ? 'selected' : ''}>Sunday</option>
                    <option ${habit.weekday === 'Monday' ? 'selected' : ''}>Monday</option>
                    <option ${habit.weekday === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
                    <option ${habit.weekday === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
                    <option ${habit.weekday === 'Thursday' ? 'selected' : ''}>Thursday</option>
                    <option ${habit.weekday === 'Friday' ? 'selected' : ''}>Friday</option>
                    <option ${habit.weekday === 'Saturday' ? 'selected' : ''}>Saturday</option>
                </select>
            `;
        } else if (habit.type === 'monthly-day') {
            return `
                <label>Day of month</label>
                <select onchange="updateHabit(${habit.id}, 'monthDay', this.value)" style="padding: 8px;">
                    ${Array.from({length: 31}, (_, i) => i + 1).map(day => `
                        <option value="${day}" ${(habit.monthDay || 1) == day ? 'selected' : ''}>${day}${getOrdinalSuffix(day)}</option>
                    `).join('')}
                </select>
            `;
        }
        return '';
    }
    
    function getDayName(date) {
        const longDayName = document.getElementById('longDayName').checked;
        return date.toLocaleDateString('en-GB', { 
            weekday: longDayName ? 'long' : 'short' 
        });
    }
    
    function getWeekNumber(date) {
        const tempDate = new Date(date.getTime());
        tempDate.setHours(0, 0, 0, 0);
        tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
        const week1 = new Date(tempDate.getFullYear(), 0, 4);
        return 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }
    
    function getOrdinalSuffix(day) {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    }
    
    function formatDate(date) {
        const dateFormatSelect = document.getElementById('dateFormat').value;
        
        const day = date.getDate();
        const dayPadded = day.toString().padStart(2, '0');
        const month = date.toLocaleDateString('en-GB', { month: 'short' });
        const monthLong = date.toLocaleDateString('en-GB', { month: 'long' });
        const year = date.getFullYear();
        
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }
        
        const dayOrdinal = getOrdinal(day);
        
        switch(dateFormatSelect) {
            case 'MMM Do, yyyy':
                return `${month} ${dayOrdinal}, ${year}`;
            case 'MMM Do':
                return `${month} ${dayOrdinal}`;
            case 'D MMM':
                return `${day} ${month}`;
            case 'DD MMM':
                return `${dayPadded} ${month}`;
            case 'D MMM yyyy':
                return `${day} ${month} ${year}`;
            case 'D MMMM':
                return `${day} ${monthLong}`;
            case 'DD MMMM':
                return `${dayPadded} ${monthLong}`;
            default:
                return `${month} ${dayOrdinal}, ${year}`;
        }
    }
    
    function generateOutput() {
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);
        const addSubBullet = document.getElementById('addSubBullet').checked;
        const includeDayName = document.getElementById('includeDayName').checked;
        const dashSeparator = document.getElementById('dashSeparator').checked;
        const addTodo = document.getElementById('addTodo').checked;
        const groupByWeeks = document.getElementById('groupByWeeks').checked;
        const useHeadings = document.getElementById('useHeadings').checked;
        
        if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
            alert('Please select both start and end dates');
            return;
        }
        
        if (startDate > endDate) {
            alert('Start date must be before end date');
            return;
        }
        
        let output = [];
        
        const customTitle = document.getElementById('planTitle').value.trim();
        
        if (customTitle) {
            output.push(`- ## ${customTitle}`);
        } else if (groupByWeeks) {
            const isFullMonth = startDate.getDate() === 1 && 
                               endDate.getDate() === new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate() &&
                               startDate.getMonth() === endDate.getMonth();
            
            if (isFullMonth) {
                const monthName = startDate.toLocaleDateString('en-GB', { month: 'short' });
                const year = startDate.getFullYear();
                output.push(`- ## ${monthName} ${year}`);
            } else {
                const startMonth = startDate.toLocaleDateString('en-GB', { month: 'short' });
                const endMonth = endDate.toLocaleDateString('en-GB', { month: 'short' });
                
                if (startMonth === endMonth) {
                    output.push(`- ## ${startMonth}`);
                } else {
                    output.push(`- ## ${startMonth} - ${endMonth}`);
                }
            }
        } else {
            const isFullMonth = startDate.getDate() === 1 && 
                               endDate.getDate() === new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate() &&
                               startDate.getMonth() === endDate.getMonth();
            
            if (isFullMonth) {
                const monthName = startDate.toLocaleDateString('en-GB', { month: 'short' });
                const year = startDate.getFullYear();
                output.push(`- ## ${monthName} ${year}`);
            } else {
                const sameMonth = startDate.getMonth() === endDate.getMonth() && 
                                 startDate.getFullYear() === endDate.getFullYear();
                
                if (sameMonth) {
                    const month = startDate.toLocaleDateString('en-GB', { month: 'short' });
                    const startDay = startDate.getDate();
                    const endDay = endDate.getDate();
                    output.push(`- ## ${month} ${startDay}-${endDay}`);
                } else {
                    const startMonth = startDate.toLocaleDateString('en-GB', { month: 'short' });
                    const endMonth = endDate.toLocaleDateString('en-GB', { month: 'short' });
                    const startDay = startDate.getDate();
                    const endDay = endDate.getDate();
                    output.push(`- ## ${startMonth} ${startDay} - ${endMonth} ${endDay}`);
                }
            }
        }
        
        const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        
        output.push('  - Notes');
        
        let currentDate = new Date(startDate);
        const dateToHabits = new Map();
        
        while (currentDate <= endDate) {
            const dateKey = currentDate.toISOString().split('T')[0];
            dateToHabits.set(dateKey, []);
            
            habits.filter(h => h.type === 'daily')
                .forEach(h => dateToHabits.get(dateKey).push(h.name));
            
            habits.filter(h => h.type === 'repeating').forEach(h => {
                if (h.repeatPattern === 'every-n-days') {
                    if (h.repeatStartDate) {
                        const startDate = new Date(h.repeatStartDate);
                        const currentDateObj = new Date(dateKey);
                        const daysDiff = Math.floor((currentDateObj - startDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff >= 0 && daysDiff % (h.repeatInterval || 2) === 0) {
                            dateToHabits.get(dateKey).push(h.name);
                        }
                    }
                } else if (h.repeatPattern === 'weekdays') {
                    const dayOfWeek = new Date(dateKey).getDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        dateToHabits.get(dateKey).push(h.name);
                    }
                } else if (h.repeatPattern === 'weekends') {
                    const dayOfWeek = new Date(dateKey).getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        dateToHabits.get(dateKey).push(h.name);
                    }
                }
            });
            
            habits.filter(h => h.type === 'selected-dates').forEach(h => {
                if (h.isWorkSchedule && h.workDates && h.workDates[dateKey]) {
                    dateToHabits.get(dateKey).push(h.workDates[dateKey]);
                } else if (!h.isWorkSchedule && h.selectedDates && h.selectedDates.includes(dateKey)) {
                    dateToHabits.get(dateKey).push(h.name);
                }
            });
            
            habits.filter(h => h.type === 'specific-day' && h.specificDate === dateKey)
                .forEach(h => dateToHabits.get(dateKey).push(h.name));
            
            const dayName = currentDate.toLocaleDateString('en-GB', { weekday: 'long' });
            habits.filter(h => h.type === 'weekly-day' && h.weekday === dayName)
                .forEach(h => dateToHabits.get(dateKey).push(h.name));
            
            const dayOfMonth = currentDate.getDate();
            habits.filter(h => h.type === 'monthly-day' && h.monthDay == dayOfMonth)
                .forEach(h => dateToHabits.get(dateKey).push(h.name));
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        if (groupByWeeks) {
            currentDate = new Date(startDate);
            const unscheduledHabits = habits.filter(h => h.type === 'unscheduled');
            
            while (currentDate <= endDate) {
                const yearWeek = getWeekNumber(currentDate);
                
                const dayOfWeek = currentDate.getDay();
                const daysUntilSunday = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(currentDate.getDate() + daysUntilSunday);
                
                const actualWeekEnd = weekEnd > endDate ? endDate : weekEnd;
                
                const startMonth = currentDate.toLocaleDateString('en-GB', { month: 'short' });
                const startDay = currentDate.getDate();
                const endDay = actualWeekEnd.getDate();
                const endMonth = actualWeekEnd.toLocaleDateString('en-GB', { month: 'short' });
                
                let weekLabel;
                if (startMonth === endMonth) {
                    weekLabel = `${startMonth}: ${startDay}-${endDay}`;
                } else {
                    weekLabel = `${startMonth}: ${startDay} - ${endMonth} ${endDay}`;
                }
                
                output.push(`  - ## ${weekLabel} · W${yearWeek}`);
                
                let daysInWeek = 0;
                let tempDate = new Date(currentDate);
                while (tempDate <= actualWeekEnd) {
                    daysInWeek++;
                    tempDate.setDate(tempDate.getDate() + 1);
                }
                
                if (unscheduledHabits.length > 0) {
                    output.push('    - Unscheduled');
                    unscheduledHabits.forEach(habit => {
                        const count = daysInWeek === 7 ? 
                            habit.frequency : 
                            Math.round((daysInWeek / 7) * habit.frequency);
                        
                        for (let i = 0; i < count; i++) {
                            output.push(`      - ${addTodo ? 'TODO ' : ''}${habit.name}`);
                        }
                    });
                }
                
                while (currentDate <= actualWeekEnd) {
                    const formattedDate = formatDate(currentDate);
                    const indent = useHeadings ? '    - ### ' : '    - ';
                    let line = indent;
                    
                    if (includeDayName) {
                        const separator = dashSeparator ? ' - ' : ' ';
                        line += getDayName(currentDate) + separator;
                    }
                    
                    line += `[[${formattedDate}]]`;
                    output.push(line);
                    
                    const dateKey = currentDate.toISOString().split('T')[0];
                    const habitsForDay = dateToHabits.get(dateKey) || [];
                    habitsForDay.forEach(habitName => {
                        output.push(`      - ${addTodo ? 'TODO ' : ''}${habitName}`);
                    });
                    
                    if (addSubBullet) {
                        output.push('      - ');
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        } else {
            const unscheduledHabits = habits.filter(h => h.type === 'unscheduled');
            
            if (unscheduledHabits.length > 0) {
                output.push('  - Unscheduled');
                unscheduledHabits.forEach(habit => {
                    const count = Math.round((daysDiff / 7) * habit.frequency);
                    for (let i = 0; i < count; i++) {
                        output.push(`    - ${addTodo ? 'TODO ' : ''}${habit.name}`);
                    }
                });
            }
            
            currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const formattedDate = formatDate(currentDate);
                const indent = useHeadings ? '  - ### ' : '  - ';
                let line = indent;
                
                if (includeDayName) {
                    const separator = dashSeparator ? ' - ' : ' ';
                    line += getDayName(currentDate) + separator;
                }
                
                line += `[[${formattedDate}]]`;
                output.push(line);
                
                const dateKey = currentDate.toISOString().split('T')[0];
                const habitsForDay = dateToHabits.get(dateKey) || [];
                habitsForDay.forEach(habitName => {
                    output.push(`    - ${addTodo ? 'TODO ' : ''}${habitName}`);
                });
                
                if (addSubBullet) {
                    output.push('    - ');
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }
        
        document.getElementById('output').value = output.join('\n');
        
        if (document.getElementById('showPreview').checked) {
            updatePreview(output.join('\n'));
        }
    }
    
    function togglePreview() {
        const showPreview = document.getElementById('showPreview').checked;
        const textarea = document.getElementById('output');
        const preview = document.getElementById('outputPreview');
        
        if (showPreview) {
            textarea.style.display = 'none';
            preview.style.display = 'block';
            updatePreview(textarea.value);
        } else {
            textarea.style.display = 'block';
            preview.style.display = 'none';
        }
    }
    
    function updatePreview(text) {
        const preview = document.getElementById('outputPreview');
        if (!text) {
            preview.innerHTML = '<p style="color: #888; font-style: italic;">Generate a plan to see preview</p>';
            return;
        }
        
        preview.innerHTML = renderMarkdownPreview(text);
    }
    
    function renderMarkdownPreview(text) {
        const lines = text.split('\n');
        let html = '';
        
        lines.forEach(line => {
            const leadingSpaces = line.match(/^(\s*)/)[0].length;
            const indent = leadingSpaces / 2;
            const trimmed = line.trim();
            
            if (!trimmed) return;
            
            let processedLine = trimmed;
            let style = `margin-left: ${indent * 20}px;`;
            
            if (trimmed.startsWith('- ## ')) {
                processedLine = trimmed.substring(5);
                style += ' font-size: 20px; font-weight: 700; color: #b0513f; margin-top: 16px; margin-bottom: 8px;';
            } else if (trimmed.startsWith('- ### ')) {
                processedLine = trimmed.substring(6);
                style += ' font-size: 17px; font-weight: 600; color: #e8e8e8; margin-top: 8px; margin-bottom: 4px;';
            } else if (trimmed.startsWith('- TODO ')) {
                processedLine = '☐ ' + trimmed.substring(7);
                style += ' color: #b8b8b8; margin-bottom: 3px;';
            } else if (trimmed.startsWith('- ')) {
                processedLine = '• ' + trimmed.substring(2);
                style += ' color: #e8e8e8; margin-bottom: 3px;';
            }
            
            processedLine = processedLine.replace(/\[\[(.*?)\]\]/g, '<span style="color: #b0513f; background: rgba(176, 81, 63, 0.15); padding: 2px 6px; border-radius: 4px;">$1</span>');
            
            html += `<div style="${style}">${processedLine}</div>`;
        });
        
        return html;
    }
    
    function copyToClipboard() {
        const output = document.getElementById('output');
        output.select();
        output.setSelectionRange(0, 99999);
        
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(output.value).then(() => {
                showSuccessMessage();
            }).catch(() => {
                document.execCommand('copy');
                showSuccessMessage();
            });
        } else {
            document.execCommand('copy');
            showSuccessMessage();
        }
    }
    
    function showSuccessMessage() {
        const successMessage = document.getElementById('successMessage');
        successMessage.style.display = 'block';
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 3000);
    }
    
    // Tab switching
    function switchTab(tab) {
        const createView = document.getElementById('createView');
        const importView = document.getElementById('importView');
        const tabCreate = document.getElementById('tabCreate');
        const tabImport = document.getElementById('tabImport');
        
        if (tab === 'create') {
            createView.style.display = 'block';
            importView.style.display = 'none';
            tabCreate.style.background = '#333';
            tabCreate.style.color = '#e8e8e8';
            tabCreate.style.borderBottom = '3px solid #b0513f';
            tabImport.style.background = '#2a2a2a';
            tabImport.style.color = '#888';
            tabImport.style.borderBottom = '3px solid transparent';
        } else {
            createView.style.display = 'none';
            importView.style.display = 'block';
            tabImport.style.background = '#333';
            tabImport.style.color = '#e8e8e8';
            tabImport.style.borderBottom = '3px solid #b0513f';
            tabCreate.style.background = '#2a2a2a';
            tabCreate.style.color = '#888';
            tabCreate.style.borderBottom = '3px solid transparent';
        }
    }
    
    // ==========================================
    // IMPORT FUNCTIONALITY
    // ==========================================
    
    function loadFileContent() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        // Store filename for later saving
        importState.fileName = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('importText').value = e.target.result;
            updateCharCount();
        };
        reader.readAsText(file);
    }
    
    function updateCharCount() {
        const text = document.getElementById('importText').value;
        document.getElementById('charCount').textContent = text.length;
    }
    
    function parseImportedPlan() {
        const text = document.getElementById('importText').value;
        if (!text.trim()) {
            alert('Please paste a plan first');
            return;
        }
        
        importState.originalText = text;
        importState.originalLines = text.split('\n');
        importState.availableDates = [];
        importState.availableDateStrings = [];
        importState.dateToLineIndex = {};
        importState.selectedStart = null;
        importState.selectedEnd = null;
        
        // Parse all dates from the markdown
        const datePattern = /\[\[([^\]]+)\]\]/g;
        
        importState.originalLines.forEach((line, index) => {
            const matches = [...line.matchAll(datePattern)];
            matches.forEach(match => {
                const dateStr = match[1];
                const parsedDate = parseDateFromLogseq(dateStr);
                if (parsedDate) {
                    const dateKey = parsedDate.toISOString().split('T')[0];
                    if (!importState.dateToLineIndex[dateKey]) {
                        importState.availableDates.push(parsedDate);
                        importState.availableDateStrings.push(dateStr);
                        importState.dateToLineIndex[dateKey] = index;
                    }
                }
            });
        });
        
        if (importState.availableDates.length === 0) {
            alert('No dates found in the plan. Make sure your plan contains date links like [[Jan 1st, 2026]]');
            return;
        }
        
        // Sort dates
        importState.availableDates.sort((a, b) => a - b);
        
        // Set initial view month to first available date
        importState.currentViewMonth = new Date(importState.availableDates[0]);
        importState.currentViewMonth.setDate(1);
        
        // Update UI
        const firstDate = importState.availableDates[0];
        const lastDate = importState.availableDates[importState.availableDates.length - 1];
        
        document.getElementById('dateRangeInfo').innerHTML = `
            <strong>Found ${importState.availableDates.length} dates</strong><br>
            Range: ${firstDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })} 
            to ${lastDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
        `;
        
        document.getElementById('dateRangeSection').style.display = 'block';
        renderDatePicker();
        
        document.getElementById('dateRangeSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function parseDateFromLogseq(dateStr) {
        try {
            // Remove ordinal suffixes
            const cleaned = dateStr.replace(/(\d+)(st|nd|rd|th)/g, '$1');
            const date = new Date(cleaned);
            if (!isNaN(date.getTime())) {
                return date;
            }
        } catch (e) {
            // Parsing failed
        }
        return null;
    }
    
    function navigateMonth(direction) {
        importState.currentViewMonth.setMonth(importState.currentViewMonth.getMonth() + direction);
        renderDatePicker();
    }
    
    function renderDatePicker() {
        const grid = document.getElementById('datePickerGrid');
        const monthLabel = document.getElementById('currentMonthLabel');
        
        const viewMonth = importState.currentViewMonth;
        monthLabel.textContent = viewMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        
        // Create set of available date keys for fast lookup
        const availableDateKeys = new Set(
            importState.availableDates.map(d => d.toISOString().split('T')[0])
        );
        
        let html = '';
        
        // Day headers
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        dayNames.forEach(day => {
            html += `<div class="date-picker-header">${day}</div>`;
        });
        
        // Get first day of month and adjust for Monday start
        const firstDay = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), 1);
        let startOffset = firstDay.getDay() - 1;
        if (startOffset < 0) startOffset = 6; // Sunday
        
        // Empty cells before first day
        for (let i = 0; i < startOffset; i++) {
            html += `<div class="date-picker-btn disabled"></div>`;
        }
        
        // Days of month
        const daysInMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth() + 1, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), day);
            const dateKey = date.toISOString().split('T')[0];
            const isAvailable = availableDateKeys.has(dateKey);
            
            let className = 'date-picker-btn';
            if (isAvailable) {
                className += ' available';
                
                // Check if selected
                if (importState.selectedStart && dateKey === importState.selectedStart.toISOString().split('T')[0]) {
                    className += ' selected';
                } else if (importState.selectedEnd && dateKey === importState.selectedEnd.toISOString().split('T')[0]) {
                    className += ' selected';
                } else if (importState.selectedStart && importState.selectedEnd) {
                    // Check if in range
                    if (date > importState.selectedStart && date < importState.selectedEnd) {
                        className += ' in-range';
                    }
                }
            } else {
                className += ' disabled';
            }
            
            const clickHandler = isAvailable ? `onclick="selectImportDate('${dateKey}')"` : '';
            html += `<div class="${className}" ${clickHandler}>${day}</div>`;
        }
        
        grid.innerHTML = html;
        
        // Update input fields
        document.getElementById('importStartDate').value = importState.selectedStart ? 
            importState.selectedStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
        document.getElementById('importEndDate').value = importState.selectedEnd ? 
            importState.selectedEnd.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
    }
    
    function selectImportDate(dateKey) {
        const date = new Date(dateKey);
        
        if (!importState.selectedStart || (importState.selectedStart && importState.selectedEnd)) {
            // First click or reset
            importState.selectedStart = date;
            importState.selectedEnd = null;
        } else {
            // Second click - set end date
            if (date < importState.selectedStart) {
                // Swap if end is before start
                importState.selectedEnd = importState.selectedStart;
                importState.selectedStart = date;
            } else {
                importState.selectedEnd = date;
            }
        }
        
        renderDatePicker();
    }
    
    function confirmDateRange() {
        if (!importState.selectedStart || !importState.selectedEnd) {
            alert('Please select both a start and end date');
            return;
        }
        
        // Show add items section
        document.getElementById('selectedRangeInfo').innerHTML = `
            <strong>Adding items to:</strong><br>
            ${importState.selectedStart.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })} 
            to ${importState.selectedEnd.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}
        `;
        
        document.getElementById('addItemsSection').style.display = 'block';
        importHabits = [];
        renderImportHabits();
        
        document.getElementById('addItemsSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Import habits functions
    function addImportHabit(name, isWorkSchedule = false) {
        const habit = {
            id: Date.now() + Math.random(),
            name: name,
            type: isWorkSchedule ? 'selected-dates' : 'unscheduled',
            frequency: 1,
            specificDate: '',
            weekday: 'Monday',
            monthDay: 1,
            selectedDates: [],
            isWorkSchedule: isWorkSchedule,
            workDates: {},
            currentWorkType: 'A WFH',
            repeatPattern: 'every-n-days',
            repeatInterval: 2,
            repeatStartDate: ''
        };
        importHabits.unshift(habit);
        renderImportHabits();
    }
    
    function addCustomImportHabit() {
        const input = document.getElementById('importCustomHabit');
        const name = input.value.trim();
        if (name) {
            addImportHabit(name);
            input.value = '';
        }
    }
    
    function removeImportHabit(id) {
        importHabits = importHabits.filter(h => h.id !== id);
        renderImportHabits();
    }
    
    function updateImportHabit(id, field, value) {
        const habit = importHabits.find(h => h.id === id);
        if (habit) {
            habit[field] = value;
            renderImportHabits();
        }
    }
    
    function loadDefaultHabitsImport() {
        document.getElementById('habitFileInputImport').click();
    }
    
    function handleHabitFileUploadImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedHabits = JSON.parse(e.target.result);
                
                if (!Array.isArray(loadedHabits) || loadedHabits.length === 0) {
                    alert('Invalid habits file or file is empty.');
                    return;
                }
                
                importHabits = loadedHabits.map(h => ({
                    ...h,
                    id: Date.now() + Math.random()
                }));
                
                renderImportHabits();
                alert(`✓ Loaded ${importHabits.length} habit(s) from file`);
            } catch (error) {
                alert('Error loading file. Make sure it\'s a valid habits file.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    function toggleImportDate(habitId, dateKey) {
        const habit = importHabits.find(h => h.id === habitId);
        if (habit) {
            if (habit.isWorkSchedule) {
                if (!habit.workDates) habit.workDates = {};
                if (habit.workDates[dateKey] === habit.currentWorkType) {
                    delete habit.workDates[dateKey];
                } else {
                    habit.workDates[dateKey] = habit.currentWorkType;
                }
            } else {
                if (!habit.selectedDates) habit.selectedDates = [];
                const index = habit.selectedDates.indexOf(dateKey);
                if (index > -1) {
                    habit.selectedDates.splice(index, 1);
                } else {
                    habit.selectedDates.push(dateKey);
                }
            }
            renderImportHabits();
        }
    }
    
    function setImportWorkType(habitId, workType) {
        const habit = importHabits.find(h => h.id === habitId);
        if (habit) {
            habit.currentWorkType = workType;
            renderImportHabits();
        }
    }
    
    function getImportDateRangeButtons(habit) {
        if (!importState.selectedStart || !importState.selectedEnd) {
            return '<span style="color: #888; font-size: 13px;">Select date range first</span>';
        }
        
        let output = '';
        
        if (habit.isWorkSchedule) {
            const workTypes = ['A WFH', 'A Office', 'B WFH', 'B Office'];
            output += '<div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">';
            workTypes.forEach(type => {
                const isActive = habit.currentWorkType === type;
                const colors = getWorkTypeColor(type);
                output += `
                    <button type="button"
                        onclick="setImportWorkType(${habit.id}, '${type}')"
                        class="work-type-btn"
                        style="padding: 10px 14px; font-size: 14px; border-radius: 6px; cursor: pointer; font-weight: 500; flex: 1; min-width: 80px; ${isActive ? `background: ${colors.bg}; color: ${colors.text}; border: none;` : 'background: #2a2a2a; color: #b8b8b8; border: 2px solid #3a3a3a;'}">
                        ${type}
                    </button>
                `;
            });
            output += '</div>';
            output += '<div style="border-top: 1px solid #3a3a3a; margin-bottom: 12px;"></div>';
        }
        
        const buttons = [];
        
        // Only show dates that are in the selected range AND available in the imported plan
        const availableDateKeys = new Set(
            importState.availableDates.map(d => d.toISOString().split('T')[0])
        );
        
        let currentDate = new Date(importState.selectedStart);
        
        if (!habit.selectedDates) habit.selectedDates = [];
        if (!habit.workDates) habit.workDates = {};
        
        while (currentDate <= importState.selectedEnd) {
            const dateKey = currentDate.toISOString().split('T')[0];
            
            if (availableDateKeys.has(dateKey)) {
                const dayName = currentDate.toLocaleDateString('en-GB', { weekday: 'short' });
                const day = currentDate.getDate();
                
                let isSelected, buttonStyle;
                
                if (habit.isWorkSchedule) {
                    const workType = habit.workDates[dateKey];
                    isSelected = !!workType;
                    if (isSelected) {
                        const colors = getWorkTypeColor(workType);
                        buttonStyle = `background: ${colors.bg}; color: ${colors.text}; border: none;`;
                    } else {
                        buttonStyle = 'background: #2a2a2a; color: #b8b8b8; border: 2px solid #3a3a3a;';
                    }
                } else {
                    isSelected = habit.selectedDates.includes(dateKey);
                    buttonStyle = isSelected ? 
                        'background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%); color: white; border: none;' :
                        'background: #2a2a2a; color: #b8b8b8; border: 2px solid #3a3a3a;';
                }
                
                buttons.push(`
                    <button type="button"
                        onclick="toggleImportDate(${habit.id}, '${dateKey}')"
                        style="padding: 8px 10px; font-size: 13px; border-radius: 6px; cursor: pointer; transition: all 0.15s ease; ${buttonStyle}"
                        class="date-select-btn">
                        ${dayName} ${day}
                    </button>
                `);
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        return output + buttons.join('');
    }
    
    function renderImportHabits() {
        const container = document.getElementById('importHabitsList');
        if (importHabits.length === 0) {
            container.innerHTML = '<p style="color: #888; font-style: italic;">No items added yet. Add some above!</p>';
            return;
        }
        
        container.innerHTML = importHabits.map(habit => `
            <div class="habit-item">
                <div class="habit-header">
                    <div class="habit-name">${habit.name}</div>
                    <button class="btn-remove" onclick="removeImportHabit(${habit.id})">Remove</button>
                </div>
                <div class="habit-config">
                    <div class="form-group" style="margin: 0;">
                        <label>Schedule Type</label>
                        <select onchange="updateImportHabit(${habit.id}, 'type', this.value)" style="padding: 8px;">
                            <option value="unscheduled" ${habit.type === 'unscheduled' ? 'selected' : ''}>Unscheduled bullets</option>
                            <option value="daily" ${habit.type === 'daily' ? 'selected' : ''}>Daily (every day)</option>
                            <option value="weekly-day" ${habit.type === 'weekly-day' ? 'selected' : ''}>Every week on...</option>
                            <option value="monthly-day" ${habit.type === 'monthly-day' ? 'selected' : ''}>Every month on...</option>
                            <option value="repeating" ${habit.type === 'repeating' ? 'selected' : ''}>Repeating pattern</option>
                            <option value="selected-dates" ${habit.type === 'selected-dates' ? 'selected' : ''}>Selected dates</option>
                            <option value="specific-day" ${habit.type === 'specific-day' ? 'selected' : ''}>Specific date</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        ${getImportHabitConfigHTML(habit)}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    function getImportHabitConfigHTML(habit) {
        if (habit.type === 'unscheduled') {
            return `
                <label>Times per week</label>
                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    ${[1,2,3,4,5,6,7].map(n => `
                        <button type="button" 
                            onclick="updateImportHabit(${habit.id}, 'frequency', ${n})"
                            style="flex: 1 1 calc(25% - 6px); min-width: 40px; padding: 10px 8px; font-size: 15px; ${habit.frequency == n ? 'background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%); color: white;' : 'background: #2a2a2a; color: #b0513f; border: 2px solid #b0513f;'}"
                            class="freq-btn">
                            ${n}x
                        </button>
                    `).join('')}
                </div>
            `;
        } else if (habit.type === 'daily') {
            return `<label style="color: #888;">Will appear on every day in selected range</label>`;
        } else if (habit.type === 'weekly-day') {
            return `
                <label>Day of week</label>
                <select onchange="updateImportHabit(${habit.id}, 'weekday', this.value)" style="padding: 8px;">
                    <option ${habit.weekday === 'Sunday' ? 'selected' : ''}>Sunday</option>
                    <option ${habit.weekday === 'Monday' ? 'selected' : ''}>Monday</option>
                    <option ${habit.weekday === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
                    <option ${habit.weekday === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
                    <option ${habit.weekday === 'Thursday' ? 'selected' : ''}>Thursday</option>
                    <option ${habit.weekday === 'Friday' ? 'selected' : ''}>Friday</option>
                    <option ${habit.weekday === 'Saturday' ? 'selected' : ''}>Saturday</option>
                </select>
            `;
        } else if (habit.type === 'monthly-day') {
            return `
                <label>Day of month</label>
                <select onchange="updateImportHabit(${habit.id}, 'monthDay', this.value)" style="padding: 8px;">
                    ${Array.from({length: 31}, (_, i) => i + 1).map(day => `
                        <option value="${day}" ${(habit.monthDay || 1) == day ? 'selected' : ''}>${day}${getOrdinalSuffix(day)}</option>
                    `).join('')}
                </select>
            `;
        } else if (habit.type === 'repeating') {
            let html = `
                <label>Repeat Pattern</label>
                <select onchange="updateImportHabit(${habit.id}, 'repeatPattern', this.value)" style="padding: 8px; margin-bottom: 8px;">
                    <option value="every-n-days" ${habit.repeatPattern === 'every-n-days' ? 'selected' : ''}>Every N days</option>
                    <option value="weekdays" ${habit.repeatPattern === 'weekdays' ? 'selected' : ''}>Weekdays only (Mon-Fri)</option>
                    <option value="weekends" ${habit.repeatPattern === 'weekends' ? 'selected' : ''}>Weekends only (Sat-Sun)</option>
                </select>
            `;
            if (habit.repeatPattern === 'every-n-days') {
                html += `
                    <label>Every how many days?</label>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                        ${[2,3,4,5,6,7].map(n => `
                            <button type="button" 
                                onclick="updateImportHabit(${habit.id}, 'repeatInterval', ${n})"
                                style="flex: 1 1 calc(33.33% - 6px); min-width: 50px; padding: 10px 8px; font-size: 15px; ${habit.repeatInterval == n ? 'background: linear-gradient(135deg, #b0513f 0%, #8d3d2f 100%); color: white;' : 'background: #2a2a2a; color: #b0513f; border: 2px solid #b0513f;'}"
                                class="freq-btn">
                                ${n}
                            </button>
                        `).join('')}
                    </div>
                    <label>Start date (first occurrence)</label>
                    <input type="date" value="${habit.repeatStartDate || ''}"
                        onchange="updateImportHabit(${habit.id}, 'repeatStartDate', this.value)"
                        style="padding: 8px;">
                `;
            }
            return html;
        } else if (habit.type === 'selected-dates') {
            return `
                <label>Select dates (tap to toggle)</label>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; padding: 8px; background: #333; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                    ${getImportDateRangeButtons(habit)}
                </div>
            `;
        } else if (habit.type === 'specific-day') {
            return `
                <label>Date</label>
                <input type="date" value="${habit.specificDate || ''}"
                    onchange="updateImportHabit(${habit.id}, 'specificDate', this.value)"
                    style="padding: 8px;">
            `;
        }
        return '';
    }
    
    function generateMergedOutput() {
        if (importHabits.length === 0) {
            alert('Please add at least one item');
            return;
        }
        
        // Build map of date -> habits to add
        const dateToNewHabits = new Map();
        
        // Get available dates in the selected range
        const availableDatesInRange = importState.availableDates
            .filter(d => d >= importState.selectedStart && d <= importState.selectedEnd);
        
        const availableDateKeys = new Set(
            availableDatesInRange.map(d => d.toISOString().split('T')[0])
        );
        
        // Separate unscheduled habits
        const unscheduledHabits = importHabits.filter(h => h.type === 'unscheduled');
        const scheduledHabits = importHabits.filter(h => h.type !== 'unscheduled');
        
        availableDateKeys.forEach(dateKey => {
            dateToNewHabits.set(dateKey, []);
            const currentDate = new Date(dateKey);
            
            scheduledHabits.forEach(habit => {
                if (habit.type === 'daily') {
                    dateToNewHabits.get(dateKey).push(habit.name);
                } else if (habit.type === 'weekly-day') {
                    const dayName = currentDate.toLocaleDateString('en-GB', { weekday: 'long' });
                    if (habit.weekday === dayName) {
                        dateToNewHabits.get(dateKey).push(habit.name);
                    }
                } else if (habit.type === 'monthly-day') {
                    const dayOfMonth = currentDate.getDate();
                    if (habit.monthDay == dayOfMonth) {
                        dateToNewHabits.get(dateKey).push(habit.name);
                    }
                } else if (habit.type === 'specific-day') {
                    if (habit.specificDate === dateKey) {
                        dateToNewHabits.get(dateKey).push(habit.name);
                    }
                } else if (habit.type === 'repeating') {
                    if (habit.repeatPattern === 'weekdays') {
                        const dayOfWeek = currentDate.getDay();
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                            dateToNewHabits.get(dateKey).push(habit.name);
                        }
                    } else if (habit.repeatPattern === 'weekends') {
                        const dayOfWeek = currentDate.getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            dateToNewHabits.get(dateKey).push(habit.name);
                        }
                    } else if (habit.repeatPattern === 'every-n-days') {
                        const startDate = habit.repeatStartDate ? new Date(habit.repeatStartDate) : importState.selectedStart;
                        const daysDiff = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= 0 && daysDiff % (habit.repeatInterval || 2) === 0) {
                            dateToNewHabits.get(dateKey).push(habit.name);
                        }
                    }
                } else if (habit.type === 'selected-dates') {
                    if (habit.isWorkSchedule && habit.workDates && habit.workDates[dateKey]) {
                        dateToNewHabits.get(dateKey).push(habit.workDates[dateKey]);
                    } else if (!habit.isWorkSchedule && habit.selectedDates && habit.selectedDates.includes(dateKey)) {
                        dateToNewHabits.get(dateKey).push(habit.name);
                    }
                }
            });
        });
        
        // Now merge into original lines
        const output = [];
        const datePattern = /\[\[([^\]]+)\]\]/;
        const weekHeaderPattern = /·\s*W(\d+)\s*$/;
        
        for (let i = 0; i < importState.originalLines.length; i++) {
            const line = importState.originalLines[i];
            output.push(line);
            
            // Check if this is a week header and we have unscheduled habits
            const weekMatch = line.match(weekHeaderPattern);
            if (weekMatch && unscheduledHabits.length > 0) {
                // First, output any property lines that follow this header (like collapsed:: true)
                while (i + 1 < importState.originalLines.length) {
                    const nextLine = importState.originalLines[i + 1];
                    // Check if it's a property line (word:: value format, indented)
                    if (/^\s+\S+::\s*/.test(nextLine)) {
                        output.push(nextLine);
                        i++;
                    } else {
                        break;
                    }
                }
                
                // Look ahead to find dates under THIS specific week header
                // and count how many are in our selected range
                let j = i + 1;
                let datesInRangeUnderThisHeader = 0;
                
                while (j < importState.originalLines.length) {
                    const nextLine = importState.originalLines[j];
                    
                    // Stop if we hit another week header (## with W number) or month header
                    if (weekHeaderPattern.test(nextLine) || /^\s*-\s*##\s*[A-Z][a-z]+\s+\d{4}\s*$/.test(nextLine)) {
                        break;
                    }
                    
                    // Check if this line has a date
                    const dateMatch = nextLine.match(datePattern);
                    if (dateMatch && nextLine.includes('###')) {
                        const parsedDate = parseDateFromLogseq(dateMatch[1]);
                        if (parsedDate) {
                            const dateKey = parsedDate.toISOString().split('T')[0];
                            if (availableDateKeys.has(dateKey)) {
                                datesInRangeUnderThisHeader++;
                            }
                        }
                    }
                    j++;
                }
                
                // Only add unscheduled if this specific week section has dates in our range
                if (datesInRangeUnderThisHeader > 0) {
                    const currentIndent = line.match(/^(\s*)/)[0].length;
                    const unschedIndent = ' '.repeat(currentIndent + 2);
                    const itemIndent = ' '.repeat(currentIndent + 4);
                    
                    output.push(`${unschedIndent}- Unscheduled`);
                    unscheduledHabits.forEach(habit => {
                        // Scale frequency based on days in this week section
                        const count = datesInRangeUnderThisHeader >= 7 ? 
                            habit.frequency : 
                            Math.max(1, Math.round((datesInRangeUnderThisHeader / 7) * habit.frequency));
                        
                        for (let k = 0; k < count; k++) {
                            output.push(`${itemIndent}- ${habit.name}`);
                        }
                    });
                }
            }
            
            // Check if this line contains a date (for scheduled habits)
            const match = line.match(datePattern);
            if (match && line.includes('###')) {
                const dateStr = match[1];
                const parsedDate = parseDateFromLogseq(dateStr);
                
                if (parsedDate) {
                    const dateKey = parsedDate.toISOString().split('T')[0];
                    const habitsToAdd = dateToNewHabits.get(dateKey) || [];
                    
                    // First, output any property lines that follow this date (like collapsed:: true)
                    while (i + 1 < importState.originalLines.length) {
                        const nextLine = importState.originalLines[i + 1];
                        // Check if it's a property line (word:: value format, indented)
                        if (/^\s+\S+::\s*/.test(nextLine)) {
                            output.push(nextLine);
                            i++;
                        } else {
                            break;
                        }
                    }
                    
                    if (habitsToAdd.length > 0) {
                        const currentIndent = line.match(/^(\s*)/)[0].length;
                        const habitIndent = ' '.repeat(currentIndent + 2);
                        
                        habitsToAdd.forEach(habitName => {
                            output.push(`${habitIndent}- ${habitName}`);
                        });
                    }
                }
            }
        }
        
        // Show output
        document.getElementById('mergedOutput').value = output.join('\n');
        document.getElementById('mergedOutputSection').style.display = 'block';
        
        if (document.getElementById('showMergedPreview').checked) {
            document.getElementById('mergedOutputPreview').innerHTML = renderMarkdownPreview(output.join('\n'));
        }
        
        document.getElementById('mergedOutputSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function toggleMergedPreview() {
        const showPreview = document.getElementById('showMergedPreview').checked;
        const textarea = document.getElementById('mergedOutput');
        const preview = document.getElementById('mergedOutputPreview');
        
        if (showPreview) {
            textarea.style.display = 'none';
            preview.style.display = 'block';
            preview.innerHTML = renderMarkdownPreview(textarea.value);
        } else {
            textarea.style.display = 'block';
            preview.style.display = 'none';
        }
    }
    
    function copyMergedToClipboard() {
        const output = document.getElementById('mergedOutput');
        output.select();
        output.setSelectionRange(0, 99999);
        
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(output.value).then(() => {
                showMergedSuccessMessage();
            }).catch(() => {
                document.execCommand('copy');
                showMergedSuccessMessage();
            });
        } else {
            document.execCommand('copy');
            showMergedSuccessMessage();
        }
    }
    
    function showMergedSuccessMessage() {
        const successMessage = document.getElementById('mergedSuccessMessage');
        successMessage.style.display = 'block';
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 3000);
    }
    
    function downloadMergedOutput() {
        const content = document.getElementById('mergedOutput').value;
        if (!content) {
            alert('No content to download');
            return;
        }
        
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = importState.fileName || '2026.md';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    
    async function saveToOriginalFile() {
        const content = document.getElementById('mergedOutput').value;
        if (!content) {
            alert('No content to save');
            return;
        }
        
        // Check if File System Access API is available
        if ('showSaveFilePicker' in window) {
            try {
                const options = {
                    suggestedName: importState.fileName || '2026.md',
                    types: [{
                        description: 'Markdown files',
                        accept: { 'text/markdown': ['.md'] }
                    }]
                };
                
                const handle = await window.showSaveFilePicker(options);
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                
                const successMessage = document.getElementById('savedSuccessMessage');
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Save failed:', err);
                    alert('Failed to save file. Try using Download instead.');
                }
            }
        } else {
            // Fallback for browsers without File System Access API
            downloadMergedOutput();
        }
    }
    
    // Initialize
    window.onload = function() {
        setDefaultDates();
        renderHabits();
    };
</script>
```

</body>
</html>